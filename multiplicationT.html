<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Klingberg Multiplikation</title>
  <meta name="description" content="A site to train multiplication">
  <meta name="Michael Morrison" content="SitePoint">

  <style type="text/css">
* {
    margin: 0;
    padding: 0;
}

body {
    background-color: #cce6ff;
    width: 100%;
    height: 100%;
}

#all {
  width: 100%;
  height: 100%;
  display: grid;
  grid-template-columns: 1fr;
  grid-template-rows: repeat(8, 1fr);
}

#top {
  grid-area: 1/1/2/2;
    margin: 2% 0 2% 40%;
}

#main {
  grid-area: 2/1/9/2;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  grid-template-rows: 1fr;
}

/*-----top------*/

#title {
    font-size: 2em;
}

/*-----main-----*/
#left {
  grid-area: 1/1/2/2;
  display: flex;
}

#right {
  grid-area: 1/2/2/3;
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  grid-template-rows: repeat(6, 1fr);
}

/*-----left------*/
#table {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr;
  grid-template-rows: repeat(10, 1fr);
}
.table-row {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  grid-template-rows: 1fr;
}
/*-----right-----*/
#display-screen {
  grid-area: 1/1/2/8;
    padding: 5%;
    border: 2px solid #550;
    background-color: #cae8cb;
}

#answer {
    background-color: #d9d9d9;
    width : 35%;
    position: center;
    text-indent: 10%;
    margin: auto;
    font-size: 2.5em;
}

#question {
    float: left;
    font-size: 2.5em;
    margin-right: 5%;
}

#numberpad {
  grid-area: 2/1/7/8;
  width: 100%;
  height: 100%;
  display: grid;
  overflow: hidden;
  grid-template-columns: repeat(5, 1fr);
  grid-template-rows: repeat(4, 1fr);
}


#meter {
    grid-area: 1/5/6/6;
    width: 100%;
    height: 100%;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: 1fr;
    background-color: #e0e0d1;
    padding: 3%;
    border: 2px solid #550;
    box-shadow: 0 5px #999;
}

#meter_inner {
  grid-area: 1/1/2/2;
  display: flex;
  height: 90%;
  border: 2px solid #550;
}
#meter_bar {
  flex: 1;
  align-self: flex-end;
  height: 10%;
  background-color: red;
}

#timer_inner {
  grid-area: 1/2/2/3;
  display: flex
  flex-direction: column;
  height: 90%;
  border: 2px solid #550;
}
#timer_bar {
  flex: 1;
  align-self: flex-end;
  background-color: red; 
}
/*----numberpad-----*/

svg{
  display: block;
  width: 100%;
  height: 100%;
}

.keypad-button {
  
  background-color: gray;
}



  </style>

</head>

<body>
  <div id="all">
    <div id="top">
        <h2 id="title">Hej</h2>
    </div>
    <div id="main">
    <div id="left">
            <div id="table">
                <div class="table-row" id="ten" style="grid-area: 1/1/2/2;" ></div>
                <div class="table-row" id="nine" style="grid-area: 2/1/3/2;" ></div>
                <div class="table-row" id="eight" style="grid-area: 3/1/4/2;"></div>
                <div class="table-row" id="seven" style="grid-area: 4/1/5/2;"></div>
                <div class="table-row" id= "six" style="grid-area: 5/1/6/2;"></div>
                <div class="table-row" id="five" style="grid-area: 6/1/7/2;"></div>
                <div class="table-row" id="four" style="grid-area: 7/1/8/2;"></div>
                <div class="table-row" id="three" style="grid-area: 8/1/9/2;"></div>
                <div class="table-row" id="two" style="grid-area: 9/1/10/2;"></div>
                <div class="table-row" id="one" style="grid-area: 10/1/11/2;"></div>
            </div>
        
    </div>
    <div id="right">
        <div id="display-screen">
            <form onsubmit="returnAnswer(); return false;">
                <label id="question" for="answer">............</label>
                <input type="number" id="answer" name="answer">
            </form>
        </div>
        <div id="numberpad">
          <div id="meter">
            <div id="meter_inner">
              <div id="meter_bar"></div>
            </div>
            <div id="timer_inner">
              <div id="timer_bar"></div>
            </div>
          </div>
          
          
            
  
          
          <div id="bstart" class="keypad-button" style="grid-area:1/4/3/5;"  onclick="start()" >
            <svg xmlns="http://www.w3.org/2000/svg">
              <defs>
              <linearGradient id="Bob">
                <stop offset="0%" stop-color="white" stop-opacity="0.5"/>
                <stop offset="50%" stop-color="#242424" stop-opacity="0.2"/>
                <stop offset="100%" stop-color="white" stop-opacity="0.2"/>
              </linearGradient>
              <filter id="f1" x="0" y="0">
                <feGaussianBlur in="SourceGraphic" stdDeviation="8" />
              </filter>
            </defs>
            <rect x="4%" y="2%" width="92%" height="98%" style="fill:red;"/>
              <text id="start-text" x="0" y="50" fill="black">START</text> 
            </svg>
          </div>
          <div class="keypad-button" id="kbd" style="grid-area:4/1/5/2;" onclick="deleteValue('kbd')"></div>
          <div class="keypad-button" id="kb0" style="grid-area:4/2/5/3;" onclick="addValue('0', 'kb0')"></div>
          
          <div class="keypad-button" style="grid-area:3/3/5/5;" onclick="returnAnswer()">
            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" >
               <path d="M57,2 L93,2 Q98,2 98,7 L98,93 Q98,98 93,98 L7,98 Q2,98 2,93 L2,57 Q2,52 7,52 L47,52 Q52,52 52,47 L52,7 Q52,2 57,2" transform="translate(-2 2)" fill="#00000037"/>
               <path d="M57,2 L93,2 Q98,2 98,7 L98,93 Q98,98 93,98 L7,98 Q2,98 2,93 L2,57 Q2,52 7,52 L47,52 Q52,52 52,47 L52,7 Q52,2 57,2"/>
               <path d="M59,2 L92,2 Q97,2 97,7 L97,91 Q97,95 92,95 L9,95 Q4,95 4,90 L4,57 Q4,52 9,52 L49,52 Q54,52 54,47 L54,7 Q54,2 59,2" fill="url(#Bob)"/>
              <text id="start-text" x="50" y="81" text-anchor="middle" font-size="30" stroke="black" fill="white">enter</text>
            </svg>
          </div>
          
          <div class="keypad-button" id="kb1" style="grid-area:3/1/4/2;" onclick="addValue('1', 'kb1')"></div>
          <div class="keypad-button" id="kb2" style="grid-area:3/2/4/3;" onclick="addValue('2', 'kb2')"></div>
          <div class="keypad-button" id="kb3" style="grid-area:3/3/4/4;" onclick="addValue('3', 'kb3')"></div>
            
          <div class="keypad-button" id="kb4" style="grid-area:2/1/3/2;" onclick="addValue('4', 'kb4')"></div>
          <div class="keypad-button" id="kb5" style="grid-area:2/2/3/3;" onclick="addValue('5', 'kb5')"></div>
          <div class="keypad-button" id="kb6" style="grid-area:2/3/3/4;" onclick="addValue('6', 'kb6')"></div>
               
          <div class="keypad-button" id="kb7" style="grid-area:1/1/2/2;" onclick="addValue('7', 'kb7')"></div>
          <div class="keypad-button" id="kb8" style="grid-area:1/2/2/3;" onclick="addValue('8', 'kb8')"></div>
          <div class="keypad-button" id="kb9" style="grid-area:1/3/2/4;" onclick="addValue('9', 'kb9')"></div>
        </div>
      
    </div>
    </div>
    </div>
<script src="//cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>
<script src="//cdn.jsdelivr.net/npm/eruda-dom"></script>
<script>eruda.add(erudaDom);</script>

    <script type="text/javascript">
window.store = {
    localStoreSupport : function() {
        try {
            return 'localStorage' in window && window['localStorage'] !== null;
        } catch (e) {
            return false;
        }
    },
    set : function(name,value,days) {
        if (days) {
            var date = new Date();
            date.setTime(date.getTime()+(days*24*60*60*1000));
            var expires = "; expires="+date.toGMTString();
        }
        else {
            var expires = "";
        }
        if( this.localStoreSupport() ) {
            localStorage.setItem(name, value);
        }
        else {
            document.cookie = name+"="+value+expires+"; path=/";
        }
    },
    get : function(name) {
        if( this.localStoreSupport() ) {
            return localStorage.getItem(name);
        }
        else {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for(var i=0;i < ca.length;i++) {
                var c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }
    },
    del : function(name) {
        if( this.localStoreSupport() ) {
            localStorage.removeItem(name);
        }
        else {
            this.set(name,"",-1);
        }
    }
}
    
let toggle = false;
let stats = get_stats();
let count = 45 - stats.products.length;
//document.getElementById('blevel').value = stats.level;
let calculatedAnswer;
let table_y_axis = ['b', 'c', 'd', 'e', 'f', 'g', 'h', 'k', 'l'];
let verticalMemory = [];
let horizontalMemory = [];
let questionText = "";
let score = document.createTextNode(" / 45");
let levelText = document.createTextNode("Nivå");
let levelBoard = document.getElementById("level")
let scoreBoard = document.getElementById("score");
let timer;
//let timerHeight = 0;
//levelBoard.appendChild(levelText);
//scoreBoard.appendChild(score);

growTable();
setLevel("4");
for (let x = 0; x < 10; x ++){
  let id = 'kb' + x;
  drawButton(id)
}
drawButton('kbd')

function createSVGElement(tag) {
  return document.createElementNS('http://www.w3.org/2000/svg', tag)
}

function setAttributes (el, atts) {
    Object.entries(atts).forEach(([key, value]) => { // note () around [k,v]!!!
        el.setAttribute(key, value);
    });
};

function drawButton(id) {
  let label = id[2];
  if (label  == 'd'){
    label = 'del'
  }
  let svg = createSVGElement('svg');
  let shadow = createSVGElement('rect');
  let base = createSVGElement('rect');
  let front = createSVGElement('rect');
  let text = createSVGElement('text');
  let node = document.createTextNode(label);
  text.appendChild(node)
  setAttributes(shadow, {
   'rx' : '5%',
   'ry' : '5%',
   'x' : '0%',
   'y' : '6%',
   'width' : '90%',
   'height' : '100%',
   'fill' : '#00000037',
 });
  setAttributes(base, {
   'rx' : '5%',
   'ry' : '5%',
   'x' : '4%',
   'y' : '4%',
   'width' : '92%',
   'height' : '92%',
   'fill' : 'black',
 });
 setAttributes(front, {
   'rx' : 5,
   'ry' : 5,
   'x' : '8%',
   'y' : '4%',
   'width' : '86%',
   'height' : '86%',
   'fill' : 'url(#Bob)',
 });
 setAttributes(text, {
   'x' : '50%',
   'y' : '62%',
   'fill' : 'white',
   'stroke' : 'black',
   'font-size': "60",
   'text-anchor': 'middle'
 })
 svg.appendChild(shadow);
 svg.appendChild(base);
 svg.appendChild(front);
 svg.appendChild(text);
 document.getElementById(id).appendChild(svg)
}

function buttonDown(id) {
  console.log('down', id)
  let svg = document.getElementById(id).children[0];
  let shadow = svg.children[0];
  let front = svg.children[2];
  let text = svg.children[3];
  setAttributes(shadow, {
    'fill': 'transparent',
  });
  setAttributes(front, {
    'x' : '6%',
   'y' : '6%',
   'width' : '88%',
   'height' : '88%',
  });
  setAttributes(text, {
    'x' : '48%',
   'y' : '65%',
  });
}

function buttonUp(id) {
  console.log('up')
  let svg = document.getElementById(id).children[0];
  let shadow = svg.children[0];
  let front = svg.children[2];
  let text = svg.children[3];
  setAttributes(shadow, {
    'fill': '#00000037',
  });
  setAttributes(front, {
  'x' : '8%',
   'y' : '4%',
   'width' : '86%',
   'height' : '86%',
  });
  setAttributes(text, {
    'x' : '50%',
   'y' : '62%',
  });
}


function flashColor(id, colorOne, colorTwo) {
  let target = document.getElementById(id)
  target.style.backgroundColor = colorTwo;
  setTimeout(() => {
    target.style.backgroundColor = colorOne;
  }, 500)
}

function shuffle(array) {
    return array.sort(() => Math.random() - 0.5);
}

function setLevel(x) {
  level = parseInt(x);
  stats.level = level;
  changeTable();
}

function newProducts() {
    let products = [];
    for (let a = 2; a < 11; a++) {
        for (let b = a; b < 11; b++) {
            let product = a.toString() + " • " + b.toString();
            products.push(product);
        }
    }
    return products;
}


function newQuestion() {
    if (stats.products.length == 0) {
        stats.products = newProducts()
    }
    shuffle(stats.products)
    questionText = stats.products.pop();
    let ansArray = questionText.split(" • ");
    calculatedAnswer = parseInt(ansArray[0]) * parseInt(ansArray[1]);
    return questionText;
}


function replaceText(id, string) {
    let target = document.getElementById(id);
    let text = document.createTextNode(string);
    target.removeChild(target.childNodes[0]);
    target.appendChild(text);
}


function meter() {
  //console.log(count)
  let meterHeight = 100*(count/45);
  //console.log(meterHeight.toString() + 'px')
  document.getElementById('meter_bar').style.height = meterHeight.toString() + 'px';
  
  //  let scoreText = count + " / 45";
  //  let levelText = "Nivå " + stats.level;
  //  replaceText("score", scoreText);
  //  replaceText("level", levelText);
}

function timerStart() {
  //  let timerHeight = 0;
  //  document.getElementById('timer_bar').style.height = '0%';
    timer = setInterval(() => {
      //console.log(stats.timerHeight)
      document.getElementById('timer_bar').style.height = stats.timerHeight.toString() + '%'
      stats.timerHeight += 1;
    }, 700)
}

function growTable() {
    let rows = ["one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten"];
    for (let i = 0; i < 10; i++) {
        let row = document.getElementById(rows[i]);
        for (let e = 0; e < 10; e++) {
            if (e == 0) {
                let input = (e + 1) * (i + 1);
                let _id = "hbtn" + i.toString();
                let functionCall = "colourHorizontal('" + _id + "')";
                let cell = document.createElement('button');
                cell.innerHTML = input;
                cell.className = "horizontalButton";
                cell.id = _id;
                cell.setAttribute("onClick", "colourHorizontal(this.id)");
                cell.style.gridArea = '1/1/2/2'
                row.appendChild(cell);
            }
            else if (i == 0) {
                let input = (e + 1) * (i + 1);
                let _id = "vbtn" + e.toString();
                let functionCall = "colourVertical('" + _id + "')";
                let cell = document.createElement('button');
                cell.innerHTML = input;
                cell.className = "verticalButton";
                cell.id = _id;
                cell.setAttribute("onClick", "colourVertical(this.id)");
                cell.style.gridArea = '1/' + (e+1).toString() + '/2/' + (e+2).toString();
                row.appendChild(cell);
            }
            else {
                let input = (e + 1) * (i + 1);
                let _id = table_y_axis[i-1] + e.toString();
                let cell = document.createElement('button');
                cell.innerHTML = input;
                cell.className = "tableBody";
                cell.style.gridArea = '1/' + (e+1).toString() + '/1/' + (e+2).toString();
                cell.id = _id;
                row.appendChild(cell);
            }
        }
    }
    document.getElementById('hbtn0').removeAttribute("onclick");
}


function clearTableBody(className) {
    let tableBodies = document.getElementsByClassName(className);
    for (let i = 0; i < tableBodies.length; i++) {
        tableBodies[i].style.backgroundColor = "#f5f5f0";
        tableBodies[i].style.color = "#000000"
    }
}


function colourVertical(text) {
    if (toggle) {
        clearTableBody("verticalButton")
        clearTableBody("tableBody")
        let button = document.getElementById(text);
        button.style.backgroundColor = "#ff9999";
        let id_number = text[4];
        verticalMemory = []
        for (let i = 0; i < table_y_axis.length; i++) {
            let _id = table_y_axis[i] + id_number;
            let tableBody = document.getElementById(_id);
            verticalMemory.push(tableBody);
            tableBody.style.backgroundColor = "#ff9999";
        }
        for (let i = 0; i < horizontalMemory.length; i++) {
            horizontalMemory[i].style.backgroundColor = "#ff9999";
        }
        for (let i = 0; i < verticalMemory.length; i++) {
            for (let j = 0; j < horizontalMemory.length; j++) {
                if (verticalMemory[i] === horizontalMemory[j]) {
                    verticalMemory[i].style.backgroundColor = "#ff0000";
                    verticalMemory[i].style.color = "#ffffff";
                }
            }
        }
        document.getElementById("answer").focus();
    }
}


function colourHorizontal(text) {
    if (toggle) {
        clearTableBody("horizontalButton")
        clearTableBody("tableBody")
        let button = document.getElementById(text);
        button.style.backgroundColor = "#ff9999";
        let id_number = text[4];
        horizontalMemory = []
        for (let i = 0; i < 9; i++) {
            let _id = table_y_axis[id_number - 1] + (i + 1).toString();
            let tableBody = document.getElementById(_id);
            horizontalMemory.push(tableBody);
            tableBody.style.backgroundColor = "#ff9999";
        }
        for (let i = 0; i < verticalMemory.length; i++) {
            verticalMemory[i].style.backgroundColor = "#ff9999";
        }
        for (let i = 0; i < verticalMemory.length; i++) {
            for (let j = 0; j < horizontalMemory.length; j++) {
                if (verticalMemory[i] === horizontalMemory[j]) {
                    verticalMemory[i].style.backgroundColor = "#ff0000";
                    verticalMemory[i].style.color = "#ffffff";
                }
            }
        }
        document.getElementById("answer").focus();
    }
}


function changeTable() {
    let rows = ["one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten"];
    let max = stats.level;
    clearTableBody("tableBody");
    clearTableBody("verticalButton");
    clearTableBody("horizontalButton");
    verticalMemory = [];
    horizontalMemory = [];
    for (let i = 1; i < 10; i++) {
        let row = document.getElementById(rows[i]);
        for (let e = 1; e < 10; e++) {
            let _id = ((i+1) * (e +1)).toString();
            row.childNodes[e].innerText = _id;
        }
    }
    for (let i = 1; i < max; i++) {
        let row = document.getElementById(rows[i]);
        for (let e = 1; e < max; e++) {
            let _id = table_y_axis[i - 1] + e.toString();
            row.childNodes[e].innerText = ''
        }
    }
  /*  for (let i = 1; i < max; i++) {
        let row = document.getElementById(rows[i]);
        for (let e = 1; e < max; e++) {
            row.deleteCell(e);
            let _id = table_y_axis[i - 1] + e.toString();
            row.insertCell(e).innerText = "";
            row.childNodes[e].setAttribute("id", _id);
            row.childNodes[e].setAttribute("class", "tableBody");
        }
    } */
}


function start() {
    changeTable();
    let button = document.getElementById("bstart");
    let buttonText = "STOP";
    questionText = newQuestion();
    replaceText("question", questionText);
    replaceText("start-text", buttonText);
    count = 45 - stats.products.length;
    meter();
    button.setAttribute("onClick", "stop()");
    document.getElementById("answer").focus();
    toggle = true;
    timerStart()
}


function stop() {
  console.log("stop")
    clearTableBody("tableBody");
    clearTableBody("verticalButton");
    clearTableBody("horizontalButton");
    verticalMemory = [];
    horizontalMemory = [];
    stats.products.push(questionText);
    let button = document.getElementById("bstart");
    let buttonText = "START";
    questionText = "............";
    replaceText("question", questionText);
    replaceText("start-text", buttonText);
    button.setAttribute("onClick", "start()");
    toggle = false;
    clearInterval(timer)
    saveStats()
}


function addValue(val, id) {
  buttonDown(id);
  setTimeout(() => {
    buttonUp(id)
  }, 250);
    if (toggle) {
        document.getElementById("answer").value += val;
    }

}


function deleteValue(id) {
  buttonDown(id);
  setTimeout(() => {
    buttonUp(id)
  }, 250);
    if (toggle) {
        let oldString = document.getElementById("answer").value;
        let newString = oldString.slice(0, -1);
        document.getElementById("answer").value = newString;
    }
}


function wrongAnswer() {
    flashColor('answer', '#d9d9d9', '#ff0000')
}


function rightAnswer() {
    flashColor('answer', '#d9d9d9', '#008000');
}


function returnAnswer() {
    if (toggle) {
        let answer = document.getElementById("answer").value;
        if (answer) {
            intAnswer = parseInt(answer);
            if (intAnswer == calculatedAnswer) {
                //rightAnswer();
                flashColor('answer', '#d9d9d9', '#008000');
                if (stats.products.length < 1) {
                    stats.level++;
                    document.getElementById('blevel').value = stats.level;
                    changeTable();
                    stats.timerHeight = 0;
                }
                newQuestion();
                clearInterval(timer)
                stats.timerHeight -= 10;
                if (stats.timerHeight < 0) {
                  stats.timerHeight = 0;
                }
                timerStart()
                count = 45 - stats.products.length;
                meter();
                replaceText("question", questionText);
                document.getElementById("answer").value = "";
                document.getElementById("answer").focus();
            }
            else {
                //wrongAnswer();
                flashColor('answer', '#d9d9d9', '#ff0000')
                stats.products.push(questionText)
                if (stats.products.length == 50) {
                    if (stats.level > 1) {
                        stats.level--;
                    }
                    else {
                        stats.level = 1;
                    }
                    document.getElementById('blevel').value = stats.level
                    changeTable();
                    stats.products = newProducts();
                    stats.timerHeight = 0;
                    count = 45 - stats.products.length
                }
                meter();
                document.getElementById("answer").value = "";
                document.getElementById("answer").focus();
            }
        }
        else {
            document.getElementById("answer").focus();
        }
        //timerStart();
    }
}


function saveStats() {
    let text = JSON.stringify(stats);
    console.log('to save', text)
    store.set('savedStats', text)
}

function get_stats() {
    let statsText = store.get('savedStats');
    console.log(statsText)
    if (!statsText){
      statsText = '{"products":[],"product":"","level":1, "timerHeight": 0}'
    console.log('not returned stats', statsText)
    }
    let stats = JSON.parse(statsText);
    console.log('returned stats', stats)
    return stats
}

function clearStats() {
  stats = {"products":[],"product":"","level":1, "timerHeight": 0};
  store.del('savedStats');
  location.reload()
 return 0
}

    </script>



</body>
</html>
